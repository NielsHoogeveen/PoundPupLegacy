@inject ILocationService LocationService
@inject IJSRuntime JSRuntime
@if(editContext is not null){
    <LabeledSearchItemEditor T="PersonListItem"
        IsMandatory="true"
        @bind-Value="RelationContext.RelationToEdit.PersonItemFrom"
        EnableEdit="true"
        Label="Person from"/>
    <div class="type-and-swap">
        <div>
            <label for="relation-type">Relation type</label>
            <select id="relation-type" @onchange="OnChangeRelationType">
                @foreach (var relationType in RelationTypes.OrderBy(x => x.Name)) {
                    @if (relationType.Id == RelationContext.RelationToEdit.InterPersonalRelationType.Id) {
                        <option selected value="@relationType.Id">@relationType.Name</option>
                    }
                    else {
                        <option value="@relationType.Id">@relationType.Name</option>
                    }
                }
            </select>
        </div>
        @if (!RelationContext.RelationToEdit.InterPersonalRelationType.IsSymmetric) {
            <button type="button" @onclick="() => Swap(RelationContext)">Swap To/From</button>
        }

    </div>
    @if (RelationContext.RelationToEdit.PersonItemTo is PersonName) {
        <div class="form-group">
            <label>Person from</label>
            <div>@RelationContext.RelationToEdit.PersonToName</div>
        </div>
    }
    @if (RelationContext.RelationToEdit.PersonItemTo is PersonListItem personListItemTo) {

        <LabeledSearchItemEditor T="PersonListItem"
            IsMandatory="true"
            @bind-Value="personListItemTo"
            EnableEdit="false"
            Label="Person to"/>
    }
    <LabeledSearchItemEditor T="DocumentListItem"
        IsMandatory="false"
        @bind-Value="RelationContext.RelationToEdit.RelationDetails.ProofDocument"
        EnableEdit="true"
        Label="Proof document" />
    <div class="form-group">
        <label>Description</label>
        <CKEditor Id="relation-editor" @bind-Value="RelationContext.RelationToEdit.RelationDetails.Description" />
    </div>
    <div class="form-group">
        <label>Start date</label>
        <InputDate @bind-Value="RelationContext.RelationToEdit.RelationDetails.DateFrom" />
    </div>
    <div class="form-group">
        <label>End date</label>
        <InputDate @bind-Value="RelationContext.RelationToEdit.RelationDetails.DateTo" />
    </div>
    <TenantNodesEditor 
        @bind-Model="RelationContext.RelationToEdit.NodeDetails.Tenants"
        ForCreate="RelationContext.RelationToEdit.NodeDetails.GetType() == typeof(NodeDetails.ForCreate)" />
}
@code {

    [Parameter]
    [EditorRequired]
    public InterPersonalRelationsEditor.RelationContext.RelationContextTo RelationContext { get; set; } = default!;


    [Parameter]
    [EditorRequired]
    public List<InterPersonalRelationTypeListItem> RelationTypes { get; set; } = default!;

    [Parameter]
    [EditorRequired]
    public Action<InterPersonalRelationsEditor.RelationContext> Swap { get; set; } = default!;

    private EditContext? editContext;
    private ValidationMessageStore? validationMessageStore;


    protected override void OnInitialized()
    {
        editContext = new EditContext(RelationContext.RelationToEdit);
        validationMessageStore = new ValidationMessageStore(editContext);
    }

    private void OnChangeRelationType(ChangeEventArgs args)
    {
        if(args.Value is not null && args.Value is string str) {
            if(int.TryParse(str, out var typeId)) {
                RelationContext.RelationToEdit.InterPersonalRelationType = RelationTypes.First(x => x.Id == typeId);
                StateHasChanged();
            }
        }
    }

    public InterPersonalRelation.To.Complete? GetValidRelation()
    {
        validationMessageStore?.Clear();
        bool hasErrors = false;
        if (RelationContext.RelationToEdit.PersonItemFrom is null) {
            validationMessageStore!.Add(editContext!.Field(nameof(RelationContext.RelationToEdit.PersonItemFrom)), "Person to is required");
            hasErrors = true;
            editContext.NotifyValidationStateChanged();
        }
        if (hasErrors)
            return null;
        return RelationContext.RelationToEdit.Match<InterPersonalRelation.To.Complete>(
            incompleteInterPersonalRelationTo: x => x.GetCompletedRelation(RelationContext.RelationToEdit.PersonItemFrom!),
            completedInterPersonalRelationTo: x => (x with { PersonFrom = RelationContext.RelationToEdit.PersonItemFrom! })
        );
    }
}

