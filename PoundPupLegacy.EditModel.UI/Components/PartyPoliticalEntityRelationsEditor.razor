@inherits EditorBase
@if (_relationToEdit is not null) {
    <ModalDialog 
        Title="Edit party political entity relation" 
        Id="party-political-relation-dialog" 
        OnOk="OnOk" 
        OnCancel="OnCancel">
        <DialogContent>
            <PartyPoliticalEntityRelationEditorDialog  
                @bind-Relation="_relationToEdit" 
                RelationTypes="@RelationTypes"/>
        </DialogContent>
    </ModalDialog>
}
<div class="relations-editor">
    <h4>Relations between this @PartyTypeName and a political entity</h4>
    @if (Relations.Any())
    {
        <div class="relations">
            <div class="grid-header first">From</div>
            <div class="grid-header">Type</div>
            <div class="grid-header">To</div>
            <div class="grid-header">Start</div>
            <div class="grid-header">End</div>
            <div class="grid-header"></div>
            <div class="grid-header"></div>
            @foreach (var relation in Relations)
            {
                var classString = relation.HasBeenDeleted ? "row deleted" : "row";
                <div class="@classString first">
                    @relation.Party.Name
                </div>
                <div class="@classString">
                    @relation.PartyPoliticalEntityRelationType.Name
                </div>
                <div class="@classString">
                    @relation.PoliticalEntity?.Name
                </div>
                <div class="@classString">
                    @relation.DateFrom
                </div>
                <div class="@classString">
                    @relation.DateTo
                </div>
                <div class="@classString">
                    @if (!relation.HasBeenDeleted) {
                        <button type="button" @onclick="() => EditRelation(relation)">edit</button>
                    }
                </div>
                <div class="@classString">
                    @if (relation.HasBeenDeleted) {
                        <button type="button" @onclick="() => RestoreRelation(relation)">restore</button>
                    }
                    else {
                        <button type="button" @onclick="() => RemoveRelation(relation)">remove</button>
                    }
                </div>
            }
        </div>
    }
    <button type="button" @onclick="OnAdd">Add</button>
</div>
@code {
    [Parameter]
    [EditorRequired]
    public List<PartyPoliticalEntityRelation> Relations { get; set; } = default!;

    [Parameter]
    [EditorRequired]
    public List<PartyPoliticalEntityRelationTypeListItem> RelationTypes { get; set; } = default!;

    [Parameter]
    [EditorRequired]
    public PartyListItem Party { get; set; } = default!;


    [Parameter]
    [EditorRequired]
    public string PartyTypeName { get; set; } = default!;

    private PartyPoliticalEntityRelation? _relationToEdit = null;

    public override async Task Validate(ValidationMessageStore validationMessageStore, List<string> invalidIds)
    {
        await Task.CompletedTask;
    }
    public override void OnTitleChange(string title)
    {

    }
    private void RestoreRelation(PartyPoliticalEntityRelation relation)
    {
        relation.HasBeenDeleted = false;
        StateHasChanged();
    }

    private void RemoveRelation(PartyPoliticalEntityRelation relation)
    {
        relation.HasBeenDeleted = true;
        StateHasChanged();
    }

    private void EditRelation(PartyPoliticalEntityRelation relationToEdit)
    {
        _relationToEdit = relationToEdit;
        StateHasChanged();
    }
    private void OnOk()
    {
        if (_relationToEdit is not null && !_relationToEdit.NodeId.HasValue) {
            Relations.Add(_relationToEdit);
        }
        _relationToEdit = null;
        StateHasChanged();
    }
    private void OnCancel()
    {
        _relationToEdit = null;
        StateHasChanged();
    }
    private void OnAdd()
    {
        _relationToEdit = new PartyPoliticalEntityRelation {
            Party = Party,
            PartyPoliticalEntityRelationType = RelationTypes.First(),
            Title = "",
            DateFrom = null,
            DateTo = null,
            Description = "",
            Files = new List<File>(),
            HasBeenDeleted = false,
            NodeId = null,
            NodeTypeName = "party political entity relation",
            OwnerId = TenantId,
            PublisherId = UserId,
            PoliticalEntity = null,
            ProofDocument = null,
            Tags = new List<Tags>(),
            TenantNodes = new List<TenantNode>(),
            Tenants = new List<Tenant>(),
            UrlId = null,           
        };
        StateHasChanged();
    }
}
