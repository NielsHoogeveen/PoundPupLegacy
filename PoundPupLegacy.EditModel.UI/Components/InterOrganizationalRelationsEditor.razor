@inherits EditorBase
<InterOrganizationalRelationsFromEditor 
    Relations="RelationsFrom" 
    RelationTypes="RelationTypes" 
    OrganizationItem="OrganizationItem"
    Swap="Swap"
    Update="UpdateFrom"
    Edit="EditRelationFrom"
    Add="AddRelationFrom"
    RelationContext="relationContext"
    Ok="OkFrom"
    Cancel="CancelFrom"
    @ref="interOrganizationalRelationsFromEditor" />

<InterOrganizationalRelationsToEditor 
    Relations="RelationsTo"
    RelationTypes="RelationTypes"
    OrganizationItem="OrganizationItem"
    Swap="Swap"
    Update="UpdateTo"
    Edit="EditRelationTo"
    Add="AddRelationTo"
    RelationContext="relationContext" Ok="OkTo"
    Cancel="CancelTo"
    @ref="interOrganizationalRelationsToEditor" />

@code {
    [Parameter]
    [EditorRequired]
    public List<CompletedInterOrganizationalRelationFrom> RelationsFrom { get; set; } = default!;
    [Parameter]
    [EditorRequired]
    public List<CompletedInterOrganizationalRelationTo> RelationsTo { get; set; } = default!;

    [Parameter]
    [EditorRequired]
    public OrganizationItem OrganizationItem { get; set; } = default!;

    [Parameter]
    [EditorRequired]
    public List<InterOrganizationalRelationTypeListItem> RelationTypes { get; set; } = default!;

    private RelationContext? relationContext = null;

    private InterOrganizationalRelationsFromEditor? interOrganizationalRelationsFromEditor;

    private InterOrganizationalRelationsToEditor? interOrganizationalRelationsToEditor;

    public abstract record RelationContext
    {
        private RelationContext() { }

        public abstract RelationContext Swap();

        public abstract record RelationContextFrom: RelationContext
        {
            private RelationContextFrom() { }
            public required InterOrganizationalRelationFrom RelationToEdit { get; init; }

            public abstract override RelationContextTo Swap();

            public abstract void Match(
                Action<RelationContextFromNew> relationContextFromNew,
                Action<RelationContextFromEditTo> relationContextFromEditTo,
                Action<RelationContextFromEditFrom> relationContextFromEditFrom
            );

            public sealed record RelationContextFromNew : RelationContextFrom
            {
                public override RelationContextTo Swap()
                {
                    return new RelationContextTo.RelationContextToNew
                    {
                            RelationToEdit = this.RelationToEdit.SwapFromAndTo()
                    };
                }
                public override void Match(
                    Action<RelationContextFromNew> relationContextFromNew,
                    Action<RelationContextFromEditTo> relationContextFromEditTo,
                    Action<RelationContextFromEditFrom> relationContextFromEditFrom
                )
                {
                    relationContextFromNew(this);
                }

            }

            public sealed record RelationContextFromEditTo: RelationContextFrom
            {
                public required CompletedInterOrganizationalRelationTo CompletedRelationToRemove { get; init; }

                public override RelationContextTo Swap()
                {
                    return new RelationContextTo.RelationContextToEditTo {
                        RelationToEdit = RelationToEdit.SwapFromAndTo(),
                        CompletedRelationToRemove = CompletedRelationToRemove
                    };
                }
                public override void Match(
                    Action<RelationContextFromNew> relationContextFromNew,
                    Action<RelationContextFromEditTo> relationContextFromEditTo,
                    Action<RelationContextFromEditFrom> relationContextFromEditFrom
                )
                {
                    relationContextFromEditTo(this);
                }

            }
            public sealed record RelationContextFromEditFrom : RelationContextFrom
            {
                public required CompletedInterOrganizationalRelationFrom CompletedRelationToRemove { get; init; }
                public override RelationContextTo Swap()
                {
                    return new RelationContextTo.RelationContextToEditFrom {
                        RelationToEdit = RelationToEdit.SwapFromAndTo(),
                        CompletedRelationToRemove = CompletedRelationToRemove
                    };
                }
                public override void Match(
                    Action<RelationContextFromNew> relationContextFromNew,
                    Action<RelationContextFromEditTo> relationContextFromEditTo,
                    Action<RelationContextFromEditFrom> relationContextFromEditFrom
                )
                {
                    relationContextFromEditFrom(this);
                }
            }
        }
        public abstract record RelationContextTo : RelationContext
        {
            private RelationContextTo() { }
            public required InterOrganizationalRelationTo RelationToEdit { get; init; }

            public abstract override RelationContextFrom Swap();

            public abstract void Match(
                Action<RelationContextToNew> relationContextToNew,
                Action<RelationContextToEditTo> relationContextToEditTo,
                Action<RelationContextToEditFrom> relationContextToEditFrom
            );

            public sealed record RelationContextToNew : RelationContextTo
            {
                public override RelationContextFrom Swap()
                {
                    return new RelationContextFrom.RelationContextFromNew {
                        RelationToEdit = this.RelationToEdit.SwapFromAndTo()
                    };
                }
                public override void Match(
                    Action<RelationContextToNew> relationContextToNew,
                    Action<RelationContextToEditTo> relationContextToEditTo,
                    Action<RelationContextToEditFrom> relationContextToEditFrom
                )
                {
                    relationContextToNew(this);
                }
            }

            public sealed record RelationContextToEditTo : RelationContextTo
            {
                public required CompletedInterOrganizationalRelationTo CompletedRelationToRemove { get; init; }
                public override RelationContextFrom Swap()
                {
                    return new RelationContextFrom.RelationContextFromEditTo {
                            RelationToEdit = RelationToEdit.SwapFromAndTo(),
                            CompletedRelationToRemove = CompletedRelationToRemove
                        };
                }
                public override void Match(
                    Action<RelationContextToNew> relationContextToNew,
                    Action<RelationContextToEditTo> relationContextToEditTo,
                    Action<RelationContextToEditFrom> relationContextToEditFrom
                )
                {
                    relationContextToEditTo(this);
                }
            }
            public sealed record RelationContextToEditFrom : RelationContextTo
            {
                public required CompletedInterOrganizationalRelationFrom CompletedRelationToRemove { get; init; }
                public override RelationContextFrom Swap()
                {
                    return new RelationContextFrom.RelationContextFromEditFrom {
                        RelationToEdit = RelationToEdit.SwapFromAndTo(),
                        CompletedRelationToRemove = CompletedRelationToRemove
                    };
                }
                public override void Match(
                    Action<RelationContextToNew> relationContextToNew,
                    Action<RelationContextToEditTo> relationContextToEditTo,
                    Action<RelationContextToEditFrom> relationContextToEditFrom
                )
                {
                    relationContextToEditFrom(this);
                }
            }
        }
    }

    public void UpdateFrom(RelationContext.RelationContextFrom relationContext)
    {

    }
    public void UpdateTo(RelationContext.RelationContextTo relationContext)
    {

    }
    private void AddRelationFrom()
    {
        var relationToEdit = OrganizationItem.Match<IncompleteInterOrganizationalRelationFrom>(
        organizationListItem: li => new NewInterOrganizationalExistingFromRelation {
                OrganizationFrom = li,
                OrganizationTo = null,
                InterOrganizationalRelationType = RelationTypes.First(),
                Title = "",
                DateFrom = null,
                DateTo = null,
                Description = "",
                Files = new List<File>(),
                NodeTypeName = "inter organizational relation",
                OwnerId = TenantId,
                PublisherId = UserId,
                GeographicalEntity = null,
                ProofDocument = null,
                Tags = new List<Tags>(),
                TenantNodes = new List<TenantNode>(),
                Tenants = new List<Tenant>(),
            },
        organizationName: nm => new NewInterOrganizationalNewFromRelation {
                OrganizationFrom = nm,
                OrganizationTo = null,
                InterOrganizationalRelationType = RelationTypes.First(),
                Title = "",
                DateFrom = null,
                DateTo = null,
                Description = "",
                Files = new List<File>(),
                NodeTypeName = "inter organizational relation",
                OwnerId = TenantId,
                PublisherId = UserId,
                GeographicalEntity = null,
                ProofDocument = null,
                Tags = new List<Tags>(),
                TenantNodes = new List<TenantNode>(),
                Tenants = new List<Tenant>(),
            }
        );
        relationContext = new RelationContext.RelationContextFrom.RelationContextFromNew {
            RelationToEdit = relationToEdit
        };
        StateHasChanged();
    }
    private void AddRelationTo()
    {
        var relationToEdit = OrganizationItem.Match<IncompleteInterOrganizationalRelationTo>(
            organizationListItem: li => new NewInterOrganizationalExistingToRelation {
                OrganizationFrom = null,
                OrganizationTo = li,
                InterOrganizationalRelationType = RelationTypes.First(),
                Title = "",
                DateFrom = null,
                DateTo = null,
                Description = "",
                Files = new List<File>(),
                NodeTypeName = "inter organizational relation",
                OwnerId = TenantId,
                PublisherId = UserId,
                GeographicalEntity = null,
                ProofDocument = null,
                Tags = new List<Tags>(),
                TenantNodes = new List<TenantNode>(),
                Tenants = new List<Tenant>(),
            },
            organizationName: nm => new NewInterOrganizationalNewToRelation {
                OrganizationFrom = null,
                OrganizationTo = nm,
                InterOrganizationalRelationType = RelationTypes.First(),
                Title = "",
                DateFrom = null,
                DateTo = null,
                Description = "",
                Files = new List<File>(),
                NodeTypeName = "inter organizational relation",
                OwnerId = TenantId,
                PublisherId = UserId,
                GeographicalEntity = null,
                ProofDocument = null,
                Tags = new List<Tags>(),
                TenantNodes = new List<TenantNode>(),
                Tenants = new List<Tenant>(),
            }
        );

        relationContext = new RelationContext.RelationContextTo.RelationContextToNew {
            RelationToEdit = relationToEdit
        };
        StateHasChanged();
    }

    private void EditRelationFrom(CompletedInterOrganizationalRelationFrom relation)
    {
        relationContext = new RelationContext.RelationContextFrom.RelationContextFromEditFrom
        {
            RelationToEdit = relation,
            CompletedRelationToRemove = relation
        };
        StateHasChanged();
    }
    private void EditRelationTo(CompletedInterOrganizationalRelationTo relation)
    {
        relationContext = new RelationContext.RelationContextTo.RelationContextToEditTo {
            RelationToEdit = relation,
            CompletedRelationToRemove = relation
        };
        StateHasChanged();
    }

    public void Swap(RelationContext relationContext)
    {
        relationContext = relationContext.Swap();        
        StateHasChanged();
    }

    public void OkFrom(InterOrganizationalRelationsEditor.RelationContext.RelationContextFrom relationContext)
    {
        if (interOrganizationalRelationsFromEditor is not null) {
            var relation = interOrganizationalRelationsFromEditor.GetValidRelation();
            if (relation is not null) {
                relationContext.Match(
                    relationContextFromNew => {
                        RelationsFrom.Add(relation);
                    },
                    relationContextFromEditTo => {
                        RelationsFrom.Add(relation);
                        RelationsTo.Remove(relationContextFromEditTo.CompletedRelationToRemove);
                    },
                    relationContextFromEditFrom => {
                        RelationsFrom.Add(relation);
                        RelationsFrom.Remove(relationContextFromEditFrom.CompletedRelationToRemove);
                    }
                );
            }
        }
        StateHasChanged();
    }
    public void CancelFrom()
    {
        relationContext = null;
        StateHasChanged();
    }
    public void OkTo(InterOrganizationalRelationsEditor.RelationContext.RelationContextTo relationContext)
    {
        if (interOrganizationalRelationsToEditor is not null) {
            var relation = interOrganizationalRelationsToEditor.GetValidRelation();
            if(relation is not null) {
                relationContext.Match(
                    relationContextToNew =>
                    {
                        RelationsTo.Add(relation);
                    },
                    relationContextToEditTo =>
                    {
                        RelationsTo.Add(relation);
                        RelationsTo.Remove(relationContextToEditTo.CompletedRelationToRemove);
                    },
                    relationContextToEditFrom =>
                    {
                        RelationsTo.Add(relation);
                        RelationsFrom.Remove(relationContextToEditFrom.CompletedRelationToRemove);
                    }
                );
            }
        }
        StateHasChanged();
    }
    public void CancelTo()
    {
        relationContext = null;
        StateHasChanged();
    }

    public override async Task Validate(ValidationMessageStore validationMessageStore, List<string> invalidIds)
    {
        await Task.CompletedTask;
    }
    public override void OnTitleChange(string title)
    {
        if(interOrganizationalRelationsFromEditor is not null) {
            interOrganizationalRelationsFromEditor.OnTitleChange(title);
        }
        if (interOrganizationalRelationsToEditor is not null) {
            interOrganizationalRelationsToEditor.OnTitleChange(title);
        }
    }
}
