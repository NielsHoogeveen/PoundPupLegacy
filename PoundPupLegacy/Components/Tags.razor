@using PoundPupLegacy.EditModel
@using PoundPupLegacy.Services;
@inject ITopicSearchService topicSearchService

@if(Elems is not null)
{
    <style>
        #tag-search{
            display: block;
            width: 20%;
            font-size: 125%;
            outline-color: cadetblue;
            margin-top: 0.5em;
            margin-bottom:0.25em;
            padding-left: 0.15em;
            padding-right: 0.15em;
        }
        .term-options{
            background-color: white;
            position: absolute;
            max-height: 10em;
            border-left: 1px solid grey;
            border-right: 1px solid grey;
            overflow-x: hidden;
            overflow-y: auto;
            z-index: 10;
            min-width:20%;
            padding-left: 0.15em;
            padding-right: 0.15em;
        }
        .term-option{
            border-bottom: 1px solid grey;
            cursor: pointer;
        }

        .tag-elements{
            width: fit-content;
            display: grid;
            grid-template-columns: auto 1em;
            margin-bottom: 0.5em;
        }
        .tag-element{
            user-select: none;
            padding-right: 0.5em;
            min-width: 15em;
            border-bottom: 1px solid grey;
        }

        .close {
            font-size: 100%;
            font-weight: 600;
            cursor: pointer;
            border-bottom: 1px solid grey;
        }

        .close:hover {
            font-size: 90%;
            font-weight: normal;
        }

        .tag-elements div:nth-last-child(-n + 2) {
            border-bottom: 0;
        }

    </style>
    <input id="tag-search" @bind="@topicSearch" @oninput="OnSetTopicSearch" />

    @if (termOptions.Any())
    {
        <div class="term-options">
        @foreach (var elem in termOptions)
        {
            <div class="term-option" @onclick="() => SelectTerm(elem.TermId)">@elem.Name</div>
        }
        </div>
    }
    @if (Elems.Any())
    {
        <div class="tag-elements">
        @foreach (var elem in Elems)
        {

            if (!elem.HasBeenDeleted)
            {
                <div class="tag-element">@elem.Name</div>
                <div class="close" @onclick="() => SetTagToDeleted(elem.TermId)">&times;</div>
            }

        }
        </div>
    }
}

@code {
    [Parameter]
    public List<Tag>? Elems { get; set; }

    [Parameter]
    public int? NodeId { get; set; }


    List<Tag> termOptions = new();

    string topicSearch { get; set; } = "";

    private void SelectTerm(int termId)
    {
        var tag = termOptions.FirstOrDefault(x => x.TermId == termId);
        if (tag is not null && Elems is not null)
        {
            var elem = Elems.FirstOrDefault(x => x.TermId == termId);
            if (elem is null)
            {
                Elems.Add(tag);
            }
            else
            {
                elem.HasBeenDeleted = false;
            }
        }
        termOptions.Clear();
        topicSearch = "";
        StateHasChanged();

    }

    private async Task OnSetTopicSearch(ChangeEventArgs args)
    {
        termOptions.Clear();
        var str = args.Value?.ToString() ?? string.Empty;
        if (!string.IsNullOrEmpty(str))
        {
            termOptions = await topicSearchService.GetTerms(NodeId, str);
        }
        StateHasChanged();
    }

    private void SetTagToDeleted(int termId)
    {

        if (Elems is not null)
        {
            var elem = Elems.FirstOrDefault(x => x.TermId == termId);
            if (elem is not null)
            {
                if (elem.IsStored)
                {
                    elem.SetToDeleted();
                }
                else
                {
                    Elems.Remove(elem);
                }
                StateHasChanged();
            }
        }
    }
}
